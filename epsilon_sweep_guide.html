<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QuaternionICP: Finite-Difference Jacobian Validation on SE(3)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">QuaternionICP
   </div>
   <div id="projectbrief">Multi-view point cloud registration using ray-projected ICP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('epsilon_sweep_guide.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Finite-Difference Jacobian Validation on SE(3)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document explains how to validate analytic Jacobians using finite differences on SE(3) with right-multiplication perturbations. The key technique is <b>epsilon sweeping</b>: never trust a single \(\varepsilon\); trust the plateau.</p>
<h1><a class="anchor" id="esg_overview"></a>
Overview</h1>
<p>Finite-difference (FD) validation compares an analytic Jacobian against numerical derivatives. For SE(3), this requires:</p>
<ol type="1">
<li>Using the correct perturbation convention (right-multiplication)</li>
<li>Sweeping \(\varepsilon\) to find a stable plateau</li>
<li>Understanding why translation and rotation behave differently</li>
</ol>
<h1><a class="anchor" id="esg_competing_errors"></a>
Two Competing Errors</h1>
<p>The central difference approximation:  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial x}
  \approx
  \frac{r(x + \varepsilon) - r(x - \varepsilon)}{2\varepsilon}
\]
</p>
<p>is affected by two competing error sources.</p>
<h2><a class="anchor" id="esg_truncation"></a>
Truncation Error (Large Epsilon)</h2>
<p>For large \(\varepsilon\), higher-order Taylor terms dominate:  </p><p class="formulaDsp">
\[
  r(x + \varepsilon) = r(x) + \varepsilon r&#39;(x) + \frac{\varepsilon^2}{2} r&#39;&#39;(x) + O(\varepsilon^3)
\]
</p>
<p>Central differences cancel the first-order error, leaving:  </p><p class="formulaDsp">
\[
  \text{Truncation error} = O(\varepsilon^2)
\]
</p>
<h2><a class="anchor" id="esg_roundoff"></a>
Roundoff Error (Small Epsilon)</h2>
<p>For very small \(\varepsilon\):</p><ul>
<li>\(r(x + \varepsilon)\) and \(r(x - \varepsilon)\) become numerically indistinguishable</li>
<li>Subtraction causes catastrophic cancellation</li>
<li>Floating-point rounding dominates</li>
</ul>
<p>This error scales as:  </p><p class="formulaDsp">
\[
  \text{Roundoff error} \sim O\!\left(\frac{\epsilon_{\text{machine}}}{\varepsilon}\right)
\]
</p>
<h1><a class="anchor" id="esg_plateau"></a>
The Plateau Phenomenon</h1>
<p>Because truncation error decreases with \(\varepsilon\) while roundoff error increases, plotting FD error versus \(\varepsilon\) yields a characteristic shape:</p>
<div class="fragment"><div class="line">error</div>
<div class="line">  |</div>
<div class="line">  |\</div>
<div class="line">  | \</div>
<div class="line">  |  \        truncation-dominated</div>
<div class="line">  |   \</div>
<div class="line">  |    -------------------  &lt;- plateau (sweet spot)</div>
<div class="line">  |                     \</div>
<div class="line">  |                      \  roundoff-dominated</div>
<div class="line">  +-----------------------------&gt; log10(eps)</div>
</div><!-- fragment --><p>The <b>plateau</b> is the stable region where both errors are small. A correct analytic Jacobian must match the FD values on this plateau.</p>
<h2><a class="anchor" id="esg_plateau_interpretation"></a>
Interpreting Results</h2>
<p><b>Case A: No plateau exists</b></p><ul>
<li>Wrong perturbation convention (left vs right)</li>
<li>Incorrect translation update formula</li>
<li>Residual has discontinuities or branching</li>
</ul>
<p><b>Case B: Plateau exists but analytic Jacobian does not match</b></p><ul>
<li>Missing Jacobian terms (e.g., denominator derivative)</li>
<li>Sign errors or wrong frame for cross products</li>
<li>Transpose errors</li>
</ul>
<p><b>Case C: Plateau exists and analytic Jacobian matches</b></p><ul>
<li>Jacobian is validated</li>
</ul>
<h1><a class="anchor" id="esg_se3_convention"></a>
SE(3) Right-Multiplication Convention</h1>
<p>A pose \(T = (R, \mathbf{t}) \in \mathrm{SE}(3)\) acts on a point \(\mathbf{p}\) as:  </p><p class="formulaDsp">
\[
  \mathbf{x} = R\,\mathbf{p} + \mathbf{t}
\]
</p>
<p>Right-multiplication perturbation:  </p><p class="formulaDsp">
\[
  T(\boldsymbol{\delta}) = T \exp(\widehat{\boldsymbol{\delta}}), \qquad
  \boldsymbol{\delta} = \begin{bmatrix} \mathbf{v} \\ \boldsymbol{\omega} \end{bmatrix} \in \mathbb{R}^6
\]
</p>
<p>The SE(3) exponential produces:  </p><p class="formulaDsp">
\[
  \exp(\widehat{\boldsymbol{\delta}}) =
  \begin{bmatrix}
    \Delta R &amp; \Delta\mathbf{t} \\
    0 &amp; 1
  \end{bmatrix}
\]
</p>
<p>Under right-multiplication, the pose updates as:  </p><p class="formulaDsp">
\[
  R&#39; = R \, \Delta R, \qquad
  \mathbf{t}&#39; = \mathbf{t} + R \, \Delta\mathbf{t}
\]
</p>
<h1><a class="anchor" id="esg_critical_pitfall"></a>
The Critical Translation Pitfall</h1>
<p>This is the most common source of FD validation failures on SE(3).</p>
<p>For a pure translation perturbation ( \(\boldsymbol{\omega} = 0\)):  </p><p class="formulaDsp">
\[
  \Delta R = I, \qquad \Delta\mathbf{t} = \mathbf{v}
\]
</p>
<p>Therefore:  </p><p class="formulaDsp">
\[
  \mathbf{t}&#39; = \mathbf{t} + R\,\mathbf{v}
\]
</p>
<p><b>Incorrect (world-frame translation):</b>  </p><p class="formulaDsp">
\[
  \mathbf{t}&#39; = \mathbf{t} + \varepsilon \mathbf{e}_k \quad \text{(WRONG)}
\]
</p>
<p><b>Correct (right-multiplication translation):</b>  </p><p class="formulaDsp">
\[
  \mathbf{t}&#39; = \mathbf{t} + R(\varepsilon \mathbf{e}_k) \quad \text{(CORRECT)}
\]
</p>
<p>The translation increment lives in the <b>local/body frame</b> and must be rotated by \(R\) to obtain the world-frame change.</p>
<h1><a class="anchor" id="esg_fd_formulas"></a>
Finite-Difference Formulas</h1>
<p>Let \(r(T)\) be a scalar residual.</p>
<h2><a class="anchor" id="esg_fd_translation"></a>
Translation Components</h2>
<p>For \(k \in \{0, 1, 2\}\):  </p><p class="formulaDsp">
\[
  R_\pm = R, \qquad
  \mathbf{t}_\pm = \mathbf{t} + R(\pm\varepsilon \mathbf{e}_k)
\]
</p>
  <p class="formulaDsp">
\[
  J_{\text{FD}}[k] \approx
  \frac{r(R_+, \mathbf{t}_+) - r(R_-, \mathbf{t}_-)}{2\varepsilon}
\]
</p>
<h2><a class="anchor" id="esg_fd_rotation"></a>
Rotation Components</h2>
<p>For \(k \in \{0, 1, 2\}\):  </p><p class="formulaDsp">
\[
  R_\pm = R \exp((\pm\varepsilon \mathbf{e}_k)^\wedge), \qquad
  \mathbf{t}_\pm = \mathbf{t}
\]
</p>
  <p class="formulaDsp">
\[
  J_{\text{FD}}[3+k] \approx
  \frac{r(R_+, \mathbf{t}_+) - r(R_-, \mathbf{t}_-)}{2\varepsilon}
\]
</p>
<h1><a class="anchor" id="esg_linear_vs_nonlinear"></a>
Why Translation and Rotation Behave Differently</h1>
<p>For the ray-projection residual \(r = a/b\) with:  </p><p class="formulaDsp">
\[
  a = \mathbf{n}^\top (R\mathbf{p} + \mathbf{t} - \mathbf{q}), \qquad
  b = \mathbf{n}^\top (R\mathbf{d})
\]
</p>
<h2><a class="anchor" id="esg_translation_linear"></a>
Translation: Linear Dependence</h2>
<p>The numerator \(a\) is <b>affine linear</b> in \(\mathbf{t}\), and the denominator \(b\) does not depend on \(\mathbf{t}\).</p>
<p>Therefore:  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial \mathbf{t}} = \frac{\mathbf{n}^\top}{b} \quad \text{(constant)}
\]
</p>
<p><b>Consequence:</b> Finite differences are exact for linear functions. There is no truncation error, so:</p><ul>
<li>Large \(\varepsilon\) values work fine</li>
<li>Relative error reaches machine precision ( \(\sim 10^{-15}\))</li>
<li>No visible plateau (flat line across all \(\varepsilon\))</li>
</ul>
<h2><a class="anchor" id="esg_rotation_nonlinear"></a>
Rotation: Nonlinear Dependence</h2>
<p>Both \(a\) and \(b\) depend on \(R\):  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial \boldsymbol{\omega}}
  = \frac{1}{b}\frac{\partial a}{\partial \boldsymbol{\omega}}
  - \frac{a}{b^2}\frac{\partial b}{\partial \boldsymbol{\omega}}
\]
</p>
<p>The quotient rule is essential. Omitting \(\partial b/\partial\boldsymbol{\omega}\) gives the "simplified" Jacobian, which can have \(\sim 10^{-2}\) error.</p>
<p><b>Consequence:</b></p><ul>
<li>Truncation error is present</li>
<li>A genuine plateau appears at \(\varepsilon \sim 10^{-6}\) to \(10^{-8}\)</li>
<li>Consistent Jacobian matches FD at \(\sim 10^{-12}\)</li>
</ul>
<h1><a class="anchor" id="esg_practical_recipe"></a>
Practical Epsilon Sweep Recipe</h1>
<h2><a class="anchor" id="esg_sweep_range"></a>
Choose a Logarithmic Sweep</h2>
<p>For double precision, sweep:  </p><p class="formulaDsp">
\[
  \varepsilon \in [10^{-2}, 10^{-9}]
\]
</p>
<p>Example values: </p><div class="fragment"><div class="line">1e-2, 3e-3, 1e-3, 3e-4, 1e-4, 3e-5, 1e-5, 3e-6, 1e-6, 3e-7, 1e-7, 3e-8, 1e-8, 3e-9, 1e-9</div>
</div><!-- fragment --><h2><a class="anchor" id="esg_sweep_procedure"></a>
Procedure</h2>
<ol type="1">
<li>Compute the analytic Jacobian \(J_{\text{ana}}\) at the current pose</li>
<li>For each \(\varepsilon\) in the sweep:<ul>
<li>For each dimension \(i \in \{0, \ldots, 5\}\):<ul>
<li>Apply the correct SE(3) perturbation (see <a class="el" href="epsilon_sweep_guide.html#esg_fd_formulas">Finite-Difference Formulas</a>)</li>
<li>Compute \(J_{\text{FD}}[i](\varepsilon)\)</li>
</ul>
</li>
<li>Compute error metrics:  <p class="formulaDsp">
\[
       \text{Absolute: } |J_{\text{FD}}[i] - J_{\text{ana}}[i]|
     \]
</p>
  <p class="formulaDsp">
\[
       \text{Relative: } \frac{|J_{\text{FD}}[i] - J_{\text{ana}}[i]|}{\max(1, |J_{\text{ana}}[i]|)}
     \]
</p>
</li>
</ul>
</li>
<li>Plot or log error versus \(\varepsilon\)</li>
<li>Identify the plateau region</li>
</ol>
<h2><a class="anchor" id="esg_typical_ranges"></a>
Typical Plateau Ranges</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Component   </th><th class="markdownTableHeadNone">Plateau Range   </th><th class="markdownTableHeadNone">Notes    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Translation   </td><td class="markdownTableBodyNone">Any reasonable \(\varepsilon\)   </td><td class="markdownTableBodyNone">Linear dependence    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rotation   </td><td class="markdownTableBodyNone">\(10^{-6}\) to \(10^{-8}\)   </td><td class="markdownTableBodyNone">Nonlinear, sweep required   </td></tr>
</table>
<h1><a class="anchor" id="esg_quotient_rule"></a>
Validating Simplified vs Consistent Jacobians</h1>
<p>The difference between consistent and simplified rotation Jacobians is:  </p><p class="formulaDsp">
\[
  J_{\text{cons}}(\omega_k) - J_{\text{simp}}(\omega_k)
  = -\frac{a}{b^2} \frac{\partial b}{\partial \omega_k}
\]
</p>
<p>This term becomes large when:</p><ul>
<li>\(|a|\) is not small (far from convergence)</li>
<li>\(|b| = |\mathbf{n}^\top \mathbf{d}|\) is small (grazing angle)</li>
<li>\(|\partial b/\partial\omega_k|\) is significant</li>
</ul>
<p>For the forward case ( \(\mathbf{d} = R\mathbf{d}_0\)):  </p><p class="formulaDsp">
\[
  \frac{\partial b}{\partial \omega_k} = -\mathbf{n}^\top R(\mathbf{d}_0 \times \mathbf{e}_k)
\]
</p>
<p>For the backward case ( \(\mathbf{d} = R^\top\mathbf{d}_0\)):  </p><p class="formulaDsp">
\[
  \frac{\partial b}{\partial \omega_k} = -\mathbf{n}^\top (\mathbf{d} \times \mathbf{e}_k)
\]
</p>
<h1><a class="anchor" id="esg_checklist"></a>
Validation Checklist</h1>
<ol type="1">
<li>Use correct SE(3) right-multiplication perturbations</li>
<li>Sweep \(\varepsilon\) logarithmically from \(10^{-2}\) to \(10^{-9}\)</li>
<li>Identify the plateau region</li>
<li>Verify analytic Jacobian matches FD on the plateau</li>
<li>Expect translation to be flat (linear) and rotation to show a plateau (nonlinear)</li>
<li>If using simplified Jacobians, verify the missing term analytically</li>
</ol>
<h1><a class="anchor" id="esg_takeaway"></a>
Key Takeaways</h1>
<ul>
<li>Never trust a single \(\varepsilon\); trust the plateau</li>
<li>For right-multiplication, translation FD must use \(\mathbf{t} + R(\varepsilon\mathbf{e}_k)\)</li>
<li>Translation is linear (no plateau); rotation is nonlinear (plateau at \(10^{-6}\) to \(10^{-8}\))</li>
<li>The quotient rule is essential for rotation Jacobians of ratio residuals </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
