<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QuaternionICP: Ray-Projection Residual Jacobians on SE(3)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">QuaternionICP
   </div>
   <div id="projectbrief">Multi-view point cloud registration using ray-projected ICP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('ray_projection_jacobian.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Ray-Projection Residual Jacobians on SE(3)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document derives the Jacobians of the ray-projection residual used in point-to-plane <a class="el" href="namespaceICP.html">ICP</a>, explaining why the <b>consistent</b> Jacobian (full quotient rule) is necessary for rotation while the <b>simplified</b> Jacobian suffices for translation.</p>
<h1><a class="anchor" id="rpj_residual"></a>
Residual Definition</h1>
<p>The ray-projection residual measures signed distance along a ray direction:  </p><p class="formulaDsp">
\[
  r = \frac{a}{b}
\]
</p>
<p>where:  </p><p class="formulaDsp">
\[
  a = \mathbf{n}^\top (\mathbf{x} - \mathbf{q}), \qquad
  b = \mathbf{n}^\top \mathbf{d}
\]
</p>
<ul>
<li>\(\mathbf{x}\): transformed source point</li>
<li>\(\mathbf{q}\): target hit point</li>
<li>\(\mathbf{n}\): target surface normal</li>
<li>\(\mathbf{d}\): ray direction (transformed)</li>
</ul>
<h2><a class="anchor" id="rpj_forward"></a>
Forward Case (Source to Target)</h2>
<p class="formulaDsp">
\[
  \mathbf{x} = R\mathbf{p} + \mathbf{t}, \qquad
  \mathbf{d} = R\mathbf{d}_0
\]
</p>
<p>where \(\mathbf{p}\) is the source point and \(\mathbf{d}_0\) is the local ray direction.</p>
<h2><a class="anchor" id="rpj_backward"></a>
Backward Case (Target to Source)</h2>
<p class="formulaDsp">
\[
  \mathbf{y} = R^\top(\mathbf{p} - \mathbf{t}), \qquad
  \mathbf{d} = R^\top\mathbf{d}_0
\]
</p>
<h1><a class="anchor" id="rpj_quotient_rule"></a>
The Quotient Rule</h1>
<p>For \(r = a/b\), the full derivative is:  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial \theta}
  = \frac{1}{b}\frac{\partial a}{\partial \theta}
  - \frac{a}{b^2}\frac{\partial b}{\partial \theta}
\]
</p>
<p>The <b>consistent</b> Jacobian uses both terms. The <b>simplified</b> Jacobian ignores \(\partial b/\partial\theta\):  </p><p class="formulaDsp">
\[
  \left.\frac{\partial r}{\partial \theta}\right|_{\text{simp}}
  = \frac{1}{b}\frac{\partial a}{\partial \theta}
\]
</p>
<h1><a class="anchor" id="rpj_translation"></a>
Translation Jacobian</h1>
<h2><a class="anchor" id="rpj_trans_numerator"></a>
Numerator Dependence</h2>
<p>The numerator:  </p><p class="formulaDsp">
\[
  a = \mathbf{n}^\top (R\mathbf{p} + \mathbf{t} - \mathbf{q})
\]
</p>
<p>is <b>affine linear</b> in \(\mathbf{t}\).</p>
<h2><a class="anchor" id="rpj_trans_denominator"></a>
Denominator Dependence</h2>
<p>The denominator:  </p><p class="formulaDsp">
\[
  b = \mathbf{n}^\top (R\mathbf{d}_0)
\]
</p>
<p>does <b>not</b> depend on \(\mathbf{t}\).</p>
<h2><a class="anchor" id="rpj_trans_jacobian"></a>
Translation Jacobian (Both Consistent and Simplified)</h2>
<p>Since \(\partial b/\partial\mathbf{t} = 0\):  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial \mathbf{t}}
  = \frac{1}{b}\frac{\partial a}{\partial \mathbf{t}}
  = \frac{\mathbf{n}^\top}{b}
\]
</p>
<p>This is <b>constant</b> — it does not depend on \(\mathbf{t}\).</p>
<h2><a class="anchor" id="rpj_trans_fd"></a>
Consequence for Finite Differences</h2>
<p>Finite differences are exact for linear functions:  </p><p class="formulaDsp">
\[
  \frac{f(x + \varepsilon) - f(x - \varepsilon)}{2\varepsilon} = f&#39;(x)
  \quad \text{(exact)}
\]
</p>
<p>Therefore:</p><ul>
<li>Large \(\varepsilon\) values work (e.g., \(10^{-2}\))</li>
<li>Relative error reaches machine precision ( \(\sim 10^{-15}\))</li>
<li>No visible plateau — flat line across all \(\varepsilon\)</li>
<li><b>Consistent and simplified Jacobians are identical</b></li>
</ul>
<h1><a class="anchor" id="rpj_rotation"></a>
Rotation Jacobian</h1>
<h2><a class="anchor" id="rpj_rot_dependence"></a>
Both Terms Depend on Rotation</h2>
<p>Numerator:  </p><p class="formulaDsp">
\[
  a(R) = \mathbf{n}^\top (R\mathbf{p} + \mathbf{t} - \mathbf{q})
\]
</p>
<p>Denominator:  </p><p class="formulaDsp">
\[
  b(R) = \mathbf{n}^\top (R\mathbf{d}_0)
\]
</p>
<p>Both depend on \(R\), so the full quotient rule applies:  </p><p class="formulaDsp">
\[
  \frac{\partial r}{\partial \boldsymbol{\omega}}
  = \frac{1}{b}\frac{\partial a}{\partial \boldsymbol{\omega}}
  - \frac{a}{b^2}\frac{\partial b}{\partial \boldsymbol{\omega}}
\]
</p>
<h2><a class="anchor" id="rpj_rot_missing"></a>
The Missing Term</h2>
<p>The difference between consistent and simplified:  </p><p class="formulaDsp">
\[
  J_{\text{cons}} - J_{\text{simp}}
  = -\frac{a}{b^2}\frac{\partial b}{\partial \boldsymbol{\omega}}
\]
</p>
<p>This term is <b>not negligible</b> in general.</p>
<h2><a class="anchor" id="rpj_rot_db_dw"></a>
Computing the Denominator Derivative</h2>
<p>For right-multiplication perturbation \(R \to R\exp(\widehat{\boldsymbol{\omega}})\):</p>
<p><b>Forward case</b> ( \(\mathbf{d} = R\mathbf{d}_0\)):</p>
<p>First-order variation:  </p><p class="formulaDsp">
\[
  \mathbf{d}&#39; \approx \mathbf{d} + R(\boldsymbol{\omega} \times \mathbf{d}_0)
  = \mathbf{d} - R(\mathbf{d}_0 \times \boldsymbol{\omega})
\]
</p>
<p>Therefore:  </p><p class="formulaDsp">
\[
  \frac{\partial \mathbf{d}}{\partial \boldsymbol{\omega}} = -R[\mathbf{d}_0]_\times
\]
</p>
<p>And:  </p><p class="formulaDsp">
\[
  \frac{\partial b}{\partial \omega_k}
  = \mathbf{n}^\top \frac{\partial \mathbf{d}}{\partial \omega_k}
  = -\mathbf{n}^\top R(\mathbf{d}_0 \times \mathbf{e}_k)
\]
</p>
<p><b>Backward case</b> ( \(\mathbf{d} = R^\top\mathbf{d}_0\)):</p>
<p>Under right-multiplication: \(R&#39;^\top = \exp(-\widehat{\boldsymbol{\omega}})R^\top\)</p>
<p>First-order variation:  </p><p class="formulaDsp">
\[
  \mathbf{d}&#39; \approx \mathbf{d} - \boldsymbol{\omega} \times \mathbf{d}
\]
</p>
<p>Therefore:  </p><p class="formulaDsp">
\[
  \frac{\partial \mathbf{d}}{\partial \boldsymbol{\omega}} = -[\mathbf{d}]_\times
\]
</p>
<p>And:  </p><p class="formulaDsp">
\[
  \frac{\partial b}{\partial \omega_k}
  = -\mathbf{n}^\top (\mathbf{d} \times \mathbf{e}_k)
\]
</p>
<h1><a class="anchor" id="rpj_when_simplified"></a>
When Simplified Fails</h1>
<p>The missing term magnitude:  </p><p class="formulaDsp">
\[
  \left| -\frac{a}{b^2}\frac{\partial b}{\partial \omega_k} \right|
\]
</p>
<p>becomes large when:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Condition   </th><th class="markdownTableHeadNone">Effect    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\(\|a\|\) large   </td><td class="markdownTableBodyNone">Far from convergence    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\(\|b\|\) small   </td><td class="markdownTableBodyNone">Grazing angle ( \(\mathbf{n} \perp \mathbf{d}\))    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\(\|\partial b/\partial\omega_k\|\) large   </td><td class="markdownTableBodyNone">Ray direction sensitive to rotation   </td></tr>
</table>
<p>For random geometry, the simplified rotation Jacobian can show **~1% to 60% error** compared to finite differences, while the consistent Jacobian matches to \(\sim 10^{-10}\).</p>
<h1><a class="anchor" id="rpj_validation"></a>
Validating Without Finite Differences</h1>
<p>To verify the consistent Jacobian analytically:</p>
<ol type="1">
<li>Compute \(a\) and \(b\) at current pose</li>
<li>Compute \(\partial b/\partial\omega_k\) analytically (see above)</li>
<li>Compute predicted difference:  <p class="formulaDsp">
\[
     \Delta_{\text{pred}}(k) = -\frac{a}{b^2}\frac{\partial b}{\partial \omega_k}
   \]
</p>
</li>
<li>Compute actual difference:  <p class="formulaDsp">
\[
     \Delta_{\text{act}}(k) = J_{\text{cons}}(\omega_k) - J_{\text{simp}}(\omega_k)
   \]
</p>
</li>
<li>Verify \(\Delta_{\text{act}}(k) \approx \Delta_{\text{pred}}(k)\) for \(k = 0,1,2\)</li>
</ol>
<h1><a class="anchor" id="rpj_fd_behavior"></a>
Finite Difference Behavior Summary</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Component   </th><th class="markdownTableHeadNone">Dependence   </th><th class="markdownTableHeadNone">FD Behavior   </th><th class="markdownTableHeadNone">Best \(\varepsilon\)   </th><th class="markdownTableHeadNone">Simplified OK?    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Translation   </td><td class="markdownTableBodyNone">Linear in \(\mathbf{t}\)   </td><td class="markdownTableBodyNone">Exact   </td><td class="markdownTableBodyNone">Any   </td><td class="markdownTableBodyNone">Yes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rotation   </td><td class="markdownTableBodyNone">Nonlinear in \(R\)   </td><td class="markdownTableBodyNone">Plateau   </td><td class="markdownTableBodyNone">\(10^{-6}\) to \(10^{-8}\)   </td><td class="markdownTableBodyNone">No   </td></tr>
</table>
<h1><a class="anchor" id="rpj_summary"></a>
Summary</h1>
<ul>
<li><b>Translation Jacobian:</b> Simplified = Consistent (denominator independent of \(\mathbf{t}\))</li>
<li><b>Rotation Jacobian:</b> Simplified ≠ Consistent (must use full quotient rule)</li>
<li><b>The missing term</b> \(-a \cdot (\partial b/\partial\boldsymbol{\omega}) / b^2\) can be large</li>
<li><b>FD validation:</b> Translation shows no plateau (linear); rotation shows plateau (nonlinear)</li>
<li><b>Always use consistent Jacobian</b> for rotation in production code </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
